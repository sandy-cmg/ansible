---
- name: Crear usuario local para desplegar los playbooks remoto
  hosts: all
  become: true
  vars:
      user: ansible

  tasks:
      - name: Verificar usuario
        ansible.builtin.stat:
            path: "/home/{{ user }}"
        register: usuario

      - name: Usuario existente
        ansible.builtin.debug:
            msg: "*** El Usuario Existe ***"
        when: usuario.stat.exists

      - name: Usuario no existente
        ansible.builtin.debug:
            msg: "*** El Usuario no Existe ***"
        when: not usuario.stat.exists

      - name: Crear usuario
        ansible.builtin.include_tasks: /etc/ansible/tasks/new_user.yml
        when: not usuario.stat.exists

      - name: "Generate SSH key for Ansible user"
        ansible.builtin.include_tasks: /etc/ansible/tasks/ssh_key.yml
        when: ansible_hostname == "servidor_ansible"
        # Este when solo lo aplico al servidor donde esta instalado ansible
        # que es el encargado de desplegar las llaves ssh a los server remoto
   
      - name: Transferir llaves si no existen
        ansible.builtin.stat:
            path: /home/{{ user }}/.ssh/authorized_keys
        register: transfer

      - name: No existen las llaves
        ansible.builtin.debug:
            msg: " *** no existen las llaves *** "
        when: not transfer.stat.exists 

      - name: Transferir llave publica a host remoto
        ansible.posix.authorized_key:
            user: "{{ user }}"
            state: present
            key: "{{ lookup('file', '/home/{{ user }}/.ssh/id_rsa.pub') }}"
        when: not transfer.stat.exists

      - name: Permiso sudo si existe usuario
        ansible.builtin.lineinfile:
            path: /etc/sudoers
            state: present
            regexp: "^{{ user }}"
            line: "{{ user }} ALL=(ALL) NOPASSWD:ALL"
            backup: true
            validate: '/usr/sbin/visudo -cf %s'
        when: usuario.stat.exists
...
